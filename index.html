<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Web Movie — Autoplay + Pause/Play</title>
<style>
  html,body{height:100%}
  body{margin:0;background:#000;color:#22ff00;font-family:system-ui,"Noto Sans KR",sans-serif;overflow:hidden}
  #stage{position:fixed;inset:0;overflow:hidden;background:#000}
  .layer{position:absolute;inset:0;display:flex;align-items:center;justify-content:center}
  .img-fill{position:absolute;inset:0;background:#000 center/cover no-repeat;will-change:transform,opacity}
  .caption{text-align:center;position:absolute;left:6vw;right:6vw;bottom:6vh;font-weight:800;line-height:1.25;text-shadow:0 2px 12px rgb(255, 0, 200)}
  .caption.small{font-size:min(2.8vw,18px)}
  .caption.large{font-size:min(4vw,20px)}
  #progress{position:fixed;left:0;right:0;top:0;height:3px;background:#111}
  #bar{height:100%;width:0;background:#39ff14;transition:width .2s linear}
  #pp{position:fixed;right:1vw;bottom:1vh;z-index:20;appearance:none;border:none;border-radius:99px;
      padding:1px px 1px 1px;font-weight:900;background:#ffffff;color:#000;cursor:pointer}
</style>
</head>
<body>

<div id="stage"></div>
<div id="progress"><div id="bar"></div></div>
<button id="pp">PAUSE</button>

<!-- 배경 음악: 처음엔 muted로 자동재생 시도, 사용자가 누르면 unmute -->
<audio id="music" preload="auto" muted
  src="https://cdn.pixabay.com/audio/2022/03/15/audio_8e2a8e.mp3"></audio>

<script>
/* ===== 1) 타임라인 (초 단위) ===== */
const TIMELINE = [
  // t: 시작시간, dur: 지속, type: 'image' | 'text'
  
  { t: 0.4, dur: 5.0, type:'text', text:'Web, Video', size:'small' },

//   { t: 5,  dur: 6, type:'image',
//     src:'https://images.unsplash.com/photo-1500530855697-b586d89ba3ee?q=80&w=1920&auto=format&fit=crop',
//     fadeIn:0.8, fadeOut:0.8, kb:{ zoom:1.15, pan:[5,-2] } },
  { t: 6,  dur: 4.8, type:'text', text:'How to make a video using a website?', size:'small' },

  { t: 11, dur: 4.8, type:'text', text:'It needs web', size:'small' },


  { t: 17, dur: 4.8, type:'text', text:'text', size:'small' },
  { t: 21, dur: 4.8, type:'text', text:'text, image', size:'small' },
  { t: 26, dur: 4.8, type:'text', text:'text, image and sound', size:'small' },
  { t: 31, dur: 4.8, type:'text', text:'but sound cannot play automatcally', size:'small' },
];
const TOTAL = Math.max(...TIMELINE.map(c => c.t + c.dur));

/* ===== 2) 전역 상태 ===== */
const stage = document.getElementById('stage');
const bar   = document.getElementById('bar');
const btn   = document.getElementById('pp');
const music = document.getElementById('music');

let started = false;
let paused  = false;
let baseTime = 0;    // 재생 시작한 performance.now()
let pauseOff = 0;    // 누적 재생 시간(초)
let rafId = null;

const clips = TIMELINE.map(c => ({...c, _started:false}));
const anims = new Set(); // 현재 활성화된 애니메이션들을 모아 pause/play 제어

/* ===== 3) 유틸 ===== */
const nowS = () => performance.now()/1000;
const curT = () => (paused ? pauseOff : (nowS() - baseTime));

function addAnim(a){ if (!a) return; anims.add(a); a.onfinish = ()=>anims.delete(a); }
function fade(layer, from, to, ms, delay=0){
  const a = layer.animate([{opacity:from},{opacity:to}], {duration:ms, delay, fill:'forwards', easing:'ease'});
  addAnim(a); return a;
}

/* ===== 4) 클립 렌더러 ===== */
function showImageClip(c){
  const layer = document.createElement('div'); layer.className = 'layer'; stage.appendChild(layer);
  const fill  = document.createElement('div'); fill.className  = 'img-fill';
  fill.style.backgroundImage = `url('${c.src}')`; layer.appendChild(fill);

  // 페이드 인/아웃
  fade(layer, 0, 1, (c.fadeIn||0.6)*1000);
  fade(layer, 1, 0, (c.fadeOut||0.6)*1000, Math.max(0,(c.dur - (c.fadeOut||0.6)))*1000)
    .onfinish = ()=> layer.remove();

  // Ken Burns
  const z = c.kb?.zoom ?? 1.12; const pan = c.kb?.pan ?? [0,0];
  addAnim(fill.animate(
    [{ transform: `scale(1) translate(0%,0%)` },
     { transform: `scale(${z}) translate(${pan[0]}%, ${pan[1]}%)` }],
    { duration: c.dur*1000, easing:'linear', fill:'forwards' }
  ));
}

function showTextClip(c){
  const layer = document.createElement('div'); layer.className = 'layer'; stage.appendChild(layer);
  const cap = document.createElement('div'); cap.className = `caption ${c.size||'small'}`; cap.textContent = c.text;
  layer.appendChild(cap);
  fade(layer, 0, 1, 400);
  fade(layer, 1, 0, 500, Math.max(0,(c.dur - 0.5))*1000).onfinish = ()=>layer.remove();
}

/* ===== 5) 메인 루프(스케줄링) ===== */
function loop(){
  const t = curT();
  // 새로 시작할 클립 실행
  for (const c of clips){
    if (!c._started && t >= c.t){
      c._started = true;
      if (c.type === 'image') showImageClip(c);
      else if (c.type === 'text') showTextClip(c);
    }
  }
  // 진행바
  bar.style.width = Math.min(100, (t/TOTAL)*100) + '%';

  if (t < TOTAL + 1) rafId = requestAnimationFrame(loop);
}

/* ===== 6) 재생/일시정지 ===== */
function play(){
  if (!started){
    started = true;
    baseTime = nowS(); pauseOff = 0;
    // 오디오: 자동재생 시도(초기 muted). 첫 버튼 클릭 시 unmute 예정.
    music?.play().catch(()=>{});
    loop();
    btn.textContent = 'PAUSE';
    return;
  }
  if (paused){
    // 재개
    baseTime = nowS() - pauseOff;
    paused = false;
    anims.forEach(a=>{ try{ a.play(); }catch(_){ } });
    music && music.play().catch(()=>{});
    rafId = requestAnimationFrame(loop);
    btn.textContent = 'PAUSE';
  }
}
function pause(){
  if (!paused){
    paused   = true;
    pauseOff = curT();
    cancelAnimationFrame(rafId);
    anims.forEach(a=>{ try{ a.pause(); }catch(_){ } });
    music && music.pause();
    btn.textContent = 'PLAY';
  }
}

btn.addEventListener('click', ()=>{
  if (!started) { play(); music.muted = false; return; }
  if (paused)   { play();  music.muted = false; }
  else          { pause(); }
});

/* ===== 7) 자동 시작 ===== */
window.addEventListener('DOMContentLoaded', ()=>{
  play(); // 자동 시작
  // 사용자가 한 번이라도 버튼을 누르면 음소거 해제
  document.body.addEventListener('pointerdown', ()=>{ music.muted = false; }, { once:true });
});
</script>
</body>
</html>
